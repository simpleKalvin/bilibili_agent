name: building

on:
  release:
    types: [ created ]  # 发布和创建时都触发

  # 允许从仓库的 Actions 标签手动运行此工作流
  workflow_dispatch:

env:
  PYTHON_VERSION: 3.11.9
  FLUTTER_VERSION: 3.24.0
  APP_NAME: "Bilibili Agent"

permissions:
  contents: write

jobs:
  build-macos:
    strategy:
      matrix:
        # macOS 架构矩阵：支持 Intel 和 ARM
        arch: [intel, arm64]
        include:
          - arch: intel
            runner: macos-15-intel  # Intel Mac (x86_64)
            target: x86_64
          - arch: arm64
            runner: macos-latest  # Apple Silicon (arm64)
            target: arm64

    runs-on: ${{ matrix.runner }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        # 安装 Flet 命令行工具到系统路径
        pip install flet[all]==0.28.3
        # 安装项目依赖
        pip install .

    - name: Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}

    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          build/flutter
        key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Flet Build macOS
      run: |
        flutter config --no-analytics
        flet build macos --verbose --build-number=${{ github.run_number }} --build-version=1.0.0

    - name: Package .app folder
      run: |
        # 确保 dist 目录存在
        mkdir -p dist
        # 查找构建目录中的 .app 文件
        if [ -d "build/macos" ]; then
          cd build/macos
          # 列出构建目录内容以确认实际文件名
          ls -la
          # 查找实际的 .app 文件
          app_file=$(find . -name "*.app" -type d | head -1)
          if [ -n "$app_file" ]; then
            app_name=$(basename "$app_file" .app)
            echo "Found app: $app_file"
            echo "App name: $app_name"
            tar -czf "$app_name-macos-${{ matrix.target }}.tar.gz" "$app_file"
            cd ../..
            cp "build/macos/$app_name-macos-${{ matrix.target }}.tar.gz" dist/
            echo "Packaged: dist/$app_name-macos-${{ matrix.target }}.tar.gz"
          else
            echo "Error: No .app file found in build/macos directory"
            ls -la
            exit 1
          fi
        else
          echo "Error: build/macos directory does not exist"
          ls -la build/
          exit 1
        fi

    - name: Upload Release Asset
      if: github.event_name == 'release'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # 查找实际的打包文件
        asset_file=$(ls dist/*-macos-${{ matrix.target }}.tar.gz 2>/dev/null | head -1)
        if [ -n "$asset_file" ]; then
          echo "Uploading: $asset_file"
          gh release upload ${{ github.event.release.tag_name }} "$asset_file" --clobber
        else
          echo "Error: No asset file found in dist directory"
          ls -la dist/
          exit 1
        fi

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\pip\Cache
          ~\AppData\Local\Microsoft\WindowsApps
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        # 安装 Flet 命令行工具到系统路径
        pip install flet[all]==0.28.3
        # 安装项目依赖
        pip install .

    - name: Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}

    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\Pub\Cache
          build\flutter
        key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Flet Build Windows
      run: |
        flutter config --no-analytics
        # 设置编码环境变量避免 Windows 控制台 Unicode 错误
        $env:PYTHONIOENCODING = "utf-8"
        $env:PYTHONUTF8 = "1"
        # 清理构建目录，避免之前的构建残留
        if (Test-Path build) {
            Remove-Item -Recurse -Force build
        }
        # 使用干净的 Python 环境构建
        flet build windows --verbose --build-number=${{ github.run_number }} --build-version=1.0.0

    - name: Package Windows executable
      run: |
        mkdir -p dist
        # 列出构建目录内容以调试
        Write-Host "Build directory contents:"
        Get-ChildItem -Recurse build\windows -ErrorAction SilentlyContinue | Select-Object FullName
        
        # 动态查找 .exe 文件
        $exeFile = Get-ChildItem -Path "build\windows" -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if ($exeFile) {
            $exeName = $exeFile.BaseName
            $exeDir = $exeFile.DirectoryName
            Write-Host "Found executable: $($exeFile.FullName)"
            
            # 打包整个目录（包含依赖的 dll 文件）
            Compress-Archive -Path "$exeDir\*" -DestinationPath "dist\$exeName-windows-x64.zip" -Force
            Write-Host "Packaged: dist\$exeName-windows-x64.zip"
        } else {
            Write-Host "Error: No .exe file found in build\windows directory"
            exit 1
        }

    - name: Upload Release Asset
      if: github.event_name == 'release'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # 查找实际的打包文件
        $assetFile = Get-ChildItem -Path "dist" -Filter "*-windows-x64.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($assetFile) {
          Write-Host "Uploading: $($assetFile.FullName)"
          gh release upload ${{ github.event.release.tag_name }} $assetFile.FullName --clobber
        } else {
          Write-Host "Error: No asset file found in dist directory"
          Get-ChildItem dist -ErrorAction SilentlyContinue
          exit 1
        }
